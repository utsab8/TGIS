{% extends 'base.html' %}
{% block content %}
<div class="max-w-7xl mx-auto mt-8 animate-fade-in">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">Survey Map <span class="text-base font-normal text-gray-500">(Interactive Features)</span></h2>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
  <style>
    #map { height: 500px; width: 100%; border-radius: 1rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    #info-panel { position: absolute; top: 90px; right: 40px; z-index: 1000; background: #fff; padding: 16px; border-radius: 10px; min-width: 220px; box-shadow: 0 2px 8px rgba(0,0,0,0.13); }
    #legend { background: white; padding: 8px 16px; border-radius: 6px; line-height: 1.5; }
    .highlight { border: 2px solid gold !important; box-shadow: 0 0 10px gold !important; }
  </style>
  <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-wrap gap-4 items-center shadow">
    <div class="flex gap-4 items-center ml-4">
      <label class="flex items-center gap-1 text-gray-700"><input type="checkbox" id="toggle-points" checked class="accent-blue-600"> Show Points</label>
      <label class="flex items-center gap-1 text-gray-700"><input type="checkbox" id="toggle-polygons" checked class="accent-blue-600"> Show Polygons</label>
    </div>
  </div>
  <div class="relative">
    <div id="map"></div>
    <div id="info-panel" style="display:none;"></div>
  </div>
  <p class="mt-6 text-center">
    <a href="{% url 'kml_export' %}" target="_blank" class="text-blue-600 hover:underline font-medium">Download All as KML (Google Earth Pro)</a>
  </p>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
  <script>
    var map = L.map('map').setView([27.7, 85.3], 10);
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });
    var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '© OpenTopoMap contributors'
    });
    var baseMaps = {
      "OpenStreetMap": osm,
      "Satellite": satellite,
      "Terrain": terrain
    };
    L.control.layers(baseMaps).addTo(map);

    // --- Marker Cluster Group for Survey Points ---
    var markers = L.markerClusterGroup();
    var surveyPoints = {{ survey_points_json|safe }};
    var pointLayerGroup = L.layerGroup();
    var customIcon = L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
    });
    var pointMarkers = {};
    surveyPoints.forEach(function(point) {
      var marker = L.marker([point.lat, point.lon], {icon: customIcon});
      marker.bindPopup('<b>Kitta:</b> ' + point.kitta + '<br><b>Owner:</b> ' + point.owner + '<br><b>Land Type:</b> ' + point.land_type + '<br><b>Area:</b> ' + point.area_size);
      marker.on('click', function() {
        showInfoPanel('<b>Kitta:</b> ' + point.kitta + '<br><b>Owner:</b> ' + point.owner + '<br><b>Land Type:</b> ' + point.land_type + '<br><b>Area:</b> ' + point.area_size + '<br><b>Lat:</b> ' + point.lat + '<br><b>Lon:</b> ' + point.lon);
      });
      marker._surveyId = point.id;
      pointMarkers[point.id] = marker;
      markers.addLayer(marker);
      pointLayerGroup.addLayer(marker);
    });
    map.addLayer(markers);
    if (surveyPoints.length > 0) {
      var bounds = L.latLngBounds(surveyPoints.map(function(p) { return [p.lat, p.lon]; }));
      map.fitBounds(bounds, {padding: [30, 30]});
    }

    // --- KML Polygon Rendering (optional, can be extended) ---
    var polygonLayerGroup = L.layerGroup();
    var boundaryFeatures = {{ boundary_data_json|safe }};
    boundaryFeatures.forEach(function(feature) {
      var layer = L.geoJSON(feature, {
        style: {color: 'red', fillOpacity: 0.25, weight: 3},
        onEachFeature: function (feature, layer) {
          layer.bindPopup('KML Polygon<br>ID: ' + (feature.properties.id || ''));
        }
      });
      polygonLayerGroup.addLayer(layer);
    });
    map.addLayer(polygonLayerGroup);

    function highlightPolygonsByKitta(kitta) {
      polygonLayerGroup.clearLayers();
      if (!kitta) return;
      fetch('/surveys/api/kmlboundary-geojson/?kitta_number=' + encodeURIComponent(kitta))
        .then(res => res.json())
        .then(data => {
          L.geoJSON(data, {
            style: {color: 'red', fillOpacity: 0.3},
            onEachFeature: function (feature, layer) {
              layer.bindPopup('KML Polygon<br>Kitta: ' + (feature.properties.kitta_number || ''));
              layer.setStyle({weight: 4});
              polygonLayerGroup.addLayer(layer);
            }
          });
        });
    }

    // --- Layer Toggles ---
    document.getElementById('toggle-points').addEventListener('change', function(e) {
      if (e.target.checked) map.addLayer(markers);
      else map.removeLayer(markers);
    });
    document.getElementById('toggle-polygons').addEventListener('change', function(e) {
      if (e.target.checked) map.addLayer(polygonLayerGroup);
      else map.removeLayer(polygonLayerGroup);
    });

    // --- Export Selected to Google Earth Pro ---
    document.getElementById('export-selected').addEventListener('click', function() {
      var kitta = document.getElementById('kitta-search').value.trim();
      if (kitta) {
        // Example: redirect to KML export for selected kitta (implement backend as needed)
        window.open('/surveys/export-kml/?kitta_number=' + encodeURIComponent(kitta), '_blank');
      } else {
        alert('Enter a Kitta number to export selection.');
      }
    });

    // --- Info Panel ---
    function showInfoPanel(html) {
      var panel = document.getElementById('info-panel');
      panel.innerHTML = html;
      panel.style.display = 'block';
    }
    map.on('click', function() {
      document.getElementById('info-panel').style.display = 'none';
    });

    // --- Map Legend ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'info legend');
      div.id = 'legend';
      div.innerHTML = '<b>Legend</b><br>' +
        '<i style="background: #3388ff; width: 12px; height: 12px; display: inline-block;"></i> Survey Point';
      return div;
    };
    legend.addTo(map);

    // --- Measurement Tools ---
    L.control.measure({
      primaryLengthUnit: 'meters',
      primaryAreaUnit: 'sqmeters',
      activeColor: '#db4a29',
      completedColor: '#9b2d14'
    }).addTo(map);

    // --- Coordinate System Conversion Example ---
    function toWGS84(lat, lon) {
      // Example: returns as-is (Leaflet uses WGS84 by default)
      return [lat, lon];
    }
  </script>
</div>
{% endblock %}
