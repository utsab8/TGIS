{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
    html {
        scroll-behavior: smooth;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Poppins', sans-serif !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
        min-height: 100vh;
        overflow-x: hidden;
    }

    /* Override base template styles */
    .max-w-7xl {
        max-width: none !important;
        padding: 0 !important;
    }

    /* Advanced Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(60px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-100px) rotate(-5deg);
        }
        to {
            opacity: 1;
            transform: translateX(0) rotate(0deg);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px) rotate(5deg);
        }
        to {
            opacity: 1;
            transform: translateX(0) rotate(0deg);
        }
    }

    @keyframes pulse {
        0%, 100% { 
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
        }
        50% { 
            transform: scale(1.05);
            box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
        }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        25% { transform: translateY(-10px) rotate(1deg); }
        50% { transform: translateY(-20px) rotate(0deg); }
        75% { transform: translateY(-10px) rotate(-1deg); }
    }

    @keyframes shimmer {
        0% { background-position: -200px 0; }
        100% { background-position: calc(200px + 100%) 0; }
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes bounce {
        0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
        40%, 43% { transform: translate3d(0, -30px, 0); }
        70% { transform: translate3d(0, -15px, 0); }
        90% { transform: translate3d(0, -4px, 0); }
    }

    /* Dashboard Container */
    .dashboard-container {
        min-height: 100vh;
        padding: 20px;
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }

    .dashboard-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
        animation: gradientShift 15s ease infinite;
        z-index: -1;
    }

    /* Header Section */
    .dashboard-header {
        text-align: center;
        margin-bottom: 40px;
        animation: fadeInUp 1s ease-out;
    }

    .dashboard-title {
        font-size: 3.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #fff 0%, #f0f0f0 50%, #fff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        position: relative;
    }

    .dashboard-title::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 4px;
        background: linear-gradient(90deg, transparent, #fff, transparent);
        border-radius: 2px;
    }

    .dashboard-subtitle {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 300;
        letter-spacing: 1px;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .stats-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
    }

    .stats-card:hover::before {
        left: 100%;
    }

    .stats-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.1),
            0 0 0 1px rgba(255, 255, 255, 0.3);
    }

    .stats-card:nth-child(1) { animation: slideInLeft 0.8s ease-out 0.1s both; }
    .stats-card:nth-child(2) { animation: slideInLeft 0.8s ease-out 0.2s both; }
    .stats-card:nth-child(3) { animation: slideInLeft 0.8s ease-out 0.3s both; }
    .stats-card:nth-child(4) { animation: slideInLeft 0.8s ease-out 0.4s both; }

    .stats-icon {
        width: 70px;
        height: 70px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .stats-icon::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
        border-radius: 20px;
    }

    .stats-card:nth-child(1) .stats-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stats-card:nth-child(2) .stats-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stats-card:nth-child(3) .stats-icon {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stats-card:nth-child(4) .stats-icon {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stats-number {
        font-size: 3rem;
        font-weight: 800;
        color: white;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        animation: pulse 2s infinite;
    }

    .stats-label {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        margin-bottom: 15px;
    }

    .progress-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
        border-radius: 10px;
        transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        animation: shimmer 2s infinite;
    }

    /* Main Content Grid */
    .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
    }

    /* Map Container */
    .map-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.8s ease-out 0.5s both;
        position: relative;
        overflow: hidden;
    }

    .map-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
        pointer-events: none;
    }

    .map-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .map-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .map-controls {
        display: flex;
        gap: 10px;
    }

    .map-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .map-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .map-btn.secondary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .map-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    #dashboard-map {
        height: 500px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Sidebar */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    /* Chart Container */
    .chart-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.8s ease-out 0.6s both;
        position: relative;
        overflow: hidden;
    }

    .chart-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-canvas {
        position: relative;
        height: 250px;
    }

    /* Recent Activity */
    .recent-activity {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: slideInRight 0.8s ease-out 0.7s both;
        position: relative;
        overflow: hidden;
    }

    .activity-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .activity-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .activity-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .activity-item:hover::before {
        opacity: 1;
    }

    .activity-item:hover {
        transform: translateX(8px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .activity-kitta {
        font-weight: 700;
        color: white;
        font-size: 1.1rem;
    }

    .activity-date {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 8px;
    }

    .activity-owner {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .activity-type {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 1000;
        cursor: pointer;
        border: none;
        animation: float 4s ease-in-out infinite;
        text-decoration: none;
    }

    .fab:hover {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        color: white;
        text-decoration: none;
    }

    .fab::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .fab:hover::before {
        opacity: 1;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .dashboard-title {
            font-size: 2.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .map-controls {
            flex-direction: column;
        }
    }

    /* Loading Animation */
    .loading {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200px 100%;
        animation: shimmer 1.5s infinite;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    /* Map Enhancements */
    .custom-marker {
        background: transparent;
        border: none;
    }

    .marker-pin {
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        animation: bounce 1s infinite;
    }

    .marker-pin i {
        transform: rotate(45deg);
    }

    .marker-cluster {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .marker-popup, .boundary-popup {
        min-width: 200px;
        font-family: 'Poppins', sans-serif;
    }

    .marker-popup h3, .boundary-popup h3 {
        color: #667eea;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .marker-popup p, .boundary-popup p {
        margin: 5px 0;
        color: #333;
    }

    .map-tiles {
        filter: brightness(0.9) contrast(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Admin-only Controls -->
    {% if is_admin %}
    <div class="mb-6 flex gap-4 justify-end">
        <a href="{% url 'user_list' %}" class="px-4 py-2 bg-blue-700 text-white rounded-lg shadow hover:bg-blue-800 transition font-semibold flex items-center gap-2">
            <i class="fas fa-users"></i> User Management
        </a>
        <a href="#logs" class="px-4 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800 transition font-semibold flex items-center gap-2">
            <i class="fas fa-file-alt"></i> Logs
        </a>
    </div>
    {% endif %}
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-chart-line"></i>
            Geo Survey Dashboard
        </h1>
        <p class="dashboard-subtitle">Real-time insights and analytics for your survey data</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stats-number">{{ total_surveys }}</div>
            <div class="stats-label">Total Surveys</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {{ surveys_progress }}%"></div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-draw-polygon"></i>
            </div>
            <div class="stats-number">{{ total_boundaries }}</div>
            <div class="stats-label">KML Boundaries</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {{ boundaries_progress }}%"></div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-ruler-combined"></i>
            </div>
            <div class="stats-number">{{ total_area|floatformat:0 }}</div>
            <div class="stats-label">Total Area (m²)</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {{ area_progress }}%"></div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="stats-number">{{ land_type_stats|length }}</div>
            <div class="stats-label">Land Types</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: {{ land_types_progress }}%"></div>
            </div>
        </div>
    </div>

    <!-- Upload History Section -->
    <div class="upload-history mt-8">
      <h3 class="text-lg font-bold mb-2 flex items-center gap-2"><i class="fas fa-upload"></i> Upload History</h3>
      <table class="min-w-full border text-sm bg-white rounded shadow">
        <thead>
          <tr>
            <th class="border px-2 py-1">Filename</th>
            <th class="border px-2 py-1">Time</th>
            <th class="border px-2 py-1">Status</th>
            <th class="border px-2 py-1">Error</th>
            <th class="border px-2 py-1">Download</th>
          </tr>
        </thead>
        <tbody>
          {% for h in upload_history %}
          <tr>
            <td class="border px-2 py-1">{{ h.filename }}</td>
            <td class="border px-2 py-1">{{ h.upload_time|date:"Y-m-d H:i" }}</td>
            <td class="border px-2 py-1">{{ h.status }}</td>
            <td class="border px-2 py-1">{{ h.error_message|truncatechars:40 }}</td>
            <td class="border px-2 py-1">
              {% if h.status == 'Failed' %}
                <a href="{% url 'download_error_report' %}" class="text-blue-600 underline">Error CSV</a>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center text-gray-400">No uploads yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Map Section -->
        <div class="map-container">
            <div class="map-header">
                <h2 class="map-title">
                    <i class="fas fa-globe-americas"></i>
                    Interactive Survey Map
                </h2>
                <div class="map-controls">
                    <button id="refresh-map" class="map-btn primary">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button id="export-kml" class="map-btn secondary">
                        <i class="fas fa-download"></i>
                        Export KML
                    </button>
                </div>
            </div>
            <div id="dashboard-map"></div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Chart -->
            <div class="chart-container">
                <h3 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Land Type Distribution
                </h3>
                <div class="chart-canvas">
                    <canvas id="landTypeChart"></canvas>
                    <script id="land-type-data" type="application/json">{{ land_type_stats|json_script:"land-type-data" }}</script>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h3 class="activity-title">
                    <i class="fas fa-clock"></i>
                    Recent Surveys
                </h3>
                <div class="activity-list">
                    {% for survey in recent_surveys %}
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-kitta">{{ survey.kitta_number|default:"N/A" }}</div>
                            <div class="activity-date">{{ survey.created_at|date:"M d" }}</div>
                        </div>
                        <div class="activity-owner">{{ survey.owner_name|default:"Unknown Owner" }}</div>
                        <div class="activity-type">{{ survey.land_type|default:"Unknown" }}</div>
                    </div>
                    {% empty %}
                    <div class="activity-item">
                        <div class="activity-header">
                            <div class="activity-kitta">No Data</div>
                        </div>
                        <div class="activity-owner">No surveys available yet</div>
                        <div class="activity-type">Add your first survey</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <a href="{% url 'survey_add' %}" class="fab">
        <i class="fas fa-plus"></i>
    </a>

    {% if is_admin %}
    <!-- Admin Tools Section -->
    <div class="mt-12 bg-white bg-opacity-80 rounded-xl shadow p-6">
        <h2 class="text-2xl font-bold text-blue-700 mb-4 flex items-center gap-2"><i class="fas fa-tools"></i> Admin Tools</h2>
        <a href="{% url 'export_users_csv' %}" class="inline-block px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition font-semibold mb-4"><i class="fas fa-file-csv"></i> Export All Users (CSV)</a>
    </div>
    <!-- Logs Section -->
    <div id="logs" class="mt-10 bg-white bg-opacity-80 rounded-xl shadow p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-file-alt"></i> System Logs</h2>
        <form method="get" class="mb-4 flex flex-wrap gap-2 items-end">
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">User</label>
                <select name="log_user" class="border rounded px-2 py-1">
                    <option value="">All</option>
                    {% for u in log_users %}
                        <option value="{{ u.id }}" {% if log_user_selected == u.id|stringformat:'s' %}selected{% endif %}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Level</label>
                <select name="log_level" class="border rounded px-2 py-1">
                    <option value="">All</option>
                    <option value="INFO" {% if log_level_selected == 'INFO' %}selected{% endif %}>INFO</option>
                    <option value="ACTION" {% if log_level_selected == 'ACTION' %}selected{% endif %}>ACTION</option>
                    <option value="ERROR" {% if log_level_selected == 'ERROR' %}selected{% endif %}>ERROR</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Start Date</label>
                <input type="date" name="log_start" value="{{ log_start_selected }}" class="border rounded px-2 py-1" />
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">End Date</label>
                <input type="date" name="log_end" value="{{ log_end_selected }}" class="border rounded px-2 py-1" />
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Keyword</label>
                <input type="text" name="log_keyword" value="{{ log_keyword }}" placeholder="Search..." class="border rounded px-2 py-1" />
            </div>
            <div>
                <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded font-semibold">Filter</button>
            </div>
        </form>
        <table class="min-w-full border text-sm bg-white rounded shadow" id="logs-table">
            <thead>
                <tr>
                    <th class="border px-2 py-1">Timestamp</th>
                    <th class="border px-2 py-1">Level</th>
                    <th class="border px-2 py-1">User</th>
                    <th class="border px-2 py-1">Action</th>
                    <th class="border px-2 py-1">Details</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="cursor-pointer hover:bg-blue-50" data-log-id="{{ log.id }}" data-log-timestamp="{{ log.timestamp|date:'Y-m-d H:i' }}" data-log-level="{{ log.level }}" data-log-user="{{ log.user.username|default:'-' }}" data-log-action="{{ log.action }}" data-log-details="{{ log.details }}">
                    <td class="border px-2 py-1">{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                    <td class="border px-2 py-1 {% if log.level == 'ERROR' %}text-red-600{% elif log.level == 'ACTION' %}text-blue-600{% else %}text-green-600{% endif %} font-bold">{{ log.level }}</td>
                    <td class="border px-2 py-1">{{ log.user.username|default:'-' }}</td>
                    <td class="border px-2 py-1">{{ log.action }}</td>
                    <td class="border px-2 py-1">{{ log.details|truncatechars:40 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-gray-400">No logs found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Log Detail Modal -->
        <div id="logDetailModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl p-8 w-full max-w-lg relative">
                <button id="closeLogModal" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                <h3 class="text-xl font-bold mb-4 text-blue-700 flex items-center gap-2"><i class="fas fa-info-circle"></i> Log Details</h3>
                <div class="mb-2"><b>Timestamp:</b> <span id="logDetailTimestamp"></span></div>
                <div class="mb-2"><b>Level:</b> <span id="logDetailLevel"></span></div>
                <div class="mb-2"><b>User:</b> <span id="logDetailUser"></span></div>
                <div class="mb-2"><b>Action:</b> <span id="logDetailAction"></span></div>
                <div class="mb-2"><b>Details:</b> <span id="logDetailDetails"></span></div>
            </div>
        </div>
        <div class="flex justify-between items-center mt-2">
            <div class="flex gap-2 items-center">
                <a href="{% url 'export_logs_csv' %}?log_user={{ log_user_selected }}&log_level={{ log_level_selected }}&log_start={{ log_start_selected }}&log_end={{ log_end_selected }}&log_keyword={{ log_keyword }}" class="inline-block px-3 py-1 bg-green-600 text-white rounded shadow hover:bg-green-700 font-semibold"><i class="fas fa-file-csv"></i> Export Filtered Logs (CSV)</a>
                <form method="post" action="{% url 'delete_old_logs' %}" onsubmit="return confirm('Delete all logs older than 90 days?');">
                    {% csrf_token %}
                    <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded shadow hover:bg-red-700 font-semibold">Delete Logs &gt; 90 Days</button>
                </form>
            </div>
            <div class="flex gap-1 items-center">
                <span id="logs-updating" class="text-xs text-blue-500 hidden"><i class="fas fa-spinner fa-spin"></i> Updating...</span>
                {% if logs.has_previous %}
                    <a href="?log_user={{ log_user_selected }}&log_level={{ log_level_selected }}&log_start={{ log_start_selected }}&log_end={{ log_end_selected }}&log_keyword={{ log_keyword }}&log_page={{ logs.previous_page_number }}" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Prev</a>
                {% endif %}
                <span class="px-2">Page {{ logs.number }} of {{ logs.paginator.num_pages }}</span>
                {% if logs.has_next %}
                    <a href="?log_user={{ log_user_selected }}&log_level={{ log_level_selected }}&log_start={{ log_start_selected }}&log_end={{ log_end_selected }}&log_keyword={{ log_keyword }}&log_page={{ logs.next_page_number }}" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Next &raquo;</a>
                {% endif %}
            </div>
        </div>
        <script>
        // Log detail modal logic
        document.querySelectorAll('#logs-table tbody tr[data-log-id]').forEach(function(row) {
            row.addEventListener('click', function() {
                document.getElementById('logDetailTimestamp').textContent = row.dataset.logTimestamp;
                document.getElementById('logDetailLevel').textContent = row.dataset.logLevel;
                document.getElementById('logDetailUser').textContent = row.dataset.logUser;
                document.getElementById('logDetailAction').textContent = row.dataset.logAction;
                document.getElementById('logDetailDetails').textContent = row.dataset.logDetails;
                document.getElementById('logDetailModal').classList.remove('hidden');
            });
        });
        document.getElementById('closeLogModal').onclick = function() {
            document.getElementById('logDetailModal').classList.add('hidden');
        };
        document.getElementById('logDetailModal').onclick = function(e) {
            if (e.target === this) this.classList.add('hidden');
        };
        // Real-time log updates
        function fetchLogs() {
            const params = new URLSearchParams(window.location.search);
            const url = '{% url "admin_logs_api" %}?' + params.toString();
            document.getElementById('logs-updating').classList.remove('hidden');
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#logs-table tbody');
                    tbody.innerHTML = '';
                    data.logs.forEach(log => {
                        const tr = document.createElement('tr');
                        tr.className = 'cursor-pointer hover:bg-blue-50';
                        tr.setAttribute('data-log-id', log.id);
                        tr.setAttribute('data-log-timestamp', log.timestamp);
                        tr.setAttribute('data-log-level', log.level);
                        tr.setAttribute('data-log-user', log.user);
                        tr.setAttribute('data-log-action', log.action);
                        tr.setAttribute('data-log-details', log.details);
                        tr.innerHTML = `
                            <td class="border px-2 py-1">${log.timestamp}</td>
                            <td class="border px-2 py-1 ${log.level === 'ERROR' ? 'text-red-600' : log.level === 'ACTION' ? 'text-blue-600' : 'text-green-600'} font-bold">${log.level}</td>
                            <td class="border px-2 py-1">${log.user}</td>
                            <td class="border px-2 py-1">${log.action}</td>
                            <td class="border px-2 py-1">${log.details.length > 40 ? log.details.substring(0, 40) + '...' : log.details}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('logs-updating').classList.add('hidden');
                    // Re-attach modal logic
                    document.querySelectorAll('#logs-table tbody tr[data-log-id]').forEach(function(row) {
                        row.addEventListener('click', function() {
                            document.getElementById('logDetailTimestamp').textContent = row.dataset.logTimestamp;
                            document.getElementById('logDetailLevel').textContent = row.dataset.logLevel;
                            document.getElementById('logDetailUser').textContent = row.dataset.logUser;
                            document.getElementById('logDetailAction').textContent = row.dataset.logAction;
                            document.getElementById('logDetailDetails').textContent = row.dataset.logDetails;
                            document.getElementById('logDetailModal').classList.remove('hidden');
                        });
                    });
                })
                .catch(() => {
                    document.getElementById('logs-updating').classList.add('hidden');
                });
        }
        setInterval(fetchLogs, 10000);
        </script>
    {% endif %}
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// Initialize map with enhanced styling
var map = L.map('dashboard-map', {
    zoomControl: false,
    attributionControl: false
}).setView([27.7, 85.3], 8);

// Add custom tile layers
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    className: 'map-tiles'
}).addTo(map);

var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri'
});

// Add layer control
var baseMaps = {
    "Street": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    "Satellite": satellite
};

L.control.layers(baseMaps, {}, {
    position: 'topright',
    collapsed: false
}).addTo(map);

// Custom marker cluster group
var markers = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    maxClusterRadius: 50,
    iconCreateFunction: function(cluster) {
        var count = cluster.getChildCount();
        var size = count > 100 ? 'large' : count > 10 ? 'medium' : 'small';
        return L.divIcon({
            html: '<div><span>' + count + '</span></div>',
            className: 'marker-cluster marker-cluster-' + size,
            iconSize: L.point(40, 40)
        });
    }
});

// Survey points data
var surveyPoints = JSON.parse('{{ survey_points_json|escapejs }}');
var boundaryData = JSON.parse('{{ boundary_data_json|escapejs }}');
const landTypeData = JSON.parse('{{ land_type_stats_json|escapejs }}');

// Add survey points with enhanced styling
surveyPoints.forEach(function(point) {
    var marker = L.marker([point.lat, point.lon], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-pin"><i class="fas fa-map-marker-alt"></i></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        })
    });
    
    var popupContent = `
        <div class="marker-popup">
            <h3>${point.kitta_number}</h3>
            <p><strong>Owner:</strong> ${point.owner_name}</p>
            <p><strong>Land Type:</strong> ${point.land_type}</p>
            <p><strong>Area:</strong> ${point.area_size} m²</p>
            <p><strong>Date:</strong> ${point.created_at}</p>
        </div>
    `;
    
    marker.bindPopup(popupContent);
    markers.addLayer(marker);
});

map.addLayer(markers);

// Add boundary polygons with enhanced styling
boundaryData.forEach(function(boundary) {
    if (boundary.coordinates && boundary.coordinates.length > 2) {
        var coords = boundary.coordinates.map(function(coord) {
            return [coord[1], coord[0]];
        });
        
        var polygon = L.polygon(coords, {
            color: '#667eea',
            fillColor: '#667eea',
            fillOpacity: 0.3,
            weight: 3,
            opacity: 0.8
        });
        
        polygon.bindPopup(`
            <div class="boundary-popup">
                <h3>${boundary.kitta_number}</h3>
                <p><strong>Area:</strong> ${boundary.area_sqm} m²</p>
            </div>
        `);
        
        polygon.addTo(map);
    }
});

// Enhanced Chart.js configuration
var ctx = document.getElementById('landTypeChart').getContext('2d');

var landTypeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(landTypeData),
        datasets: [{
            data: Object.values(landTypeData).map(item => item.count),
            backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
            ],
            borderWidth: 3,
            borderColor: 'rgba(255, 255, 255, 0.8)',
            hoverBorderWidth: 5,
            hoverBorderColor: 'rgba(255, 255, 255, 1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: {
                        family: 'Poppins',
                        size: 12
                    },
                    color: 'rgba(255, 255, 255, 0.9)'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: '#667eea',
                borderWidth: 1,
                cornerRadius: 10,
                displayColors: true
            }
        },
        animation: {
            animateRotate: true,
            animateScale: true,
            duration: 2000,
            easing: 'easeOutQuart'
        },
        cutout: '60%'
    }
});

// Interactive features
document.getElementById('refresh-map').addEventListener('click', function() {
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    setTimeout(() => {
        location.reload();
    }, 1000);
});

document.getElementById('export-kml').addEventListener('click', function() {
    this.innerHTML = '<i class="fas fa-download"></i> Exporting...';
    setTimeout(() => {
        window.open('{% url "download_all_surveys_kml" %}', '_blank');
        this.innerHTML = '<i class="fas fa-download"></i> Export KML';
    }, 1000);
});

// Add hover effects to stats cards
document.querySelectorAll('.stats-card').forEach(function(card, index) {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-15px) scale(1.05)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
    });
    
    // Add click animation
    card.addEventListener('click', function() {
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
    });
});

// Auto-refresh data every 60 seconds
setInterval(function() {
    console.log('Auto-refresh triggered');
}, 60000);

// Add loading animation for data
function showLoading(element) {
    element.classList.add('loading');
}

function hideLoading(element) {
    element.classList.remove('loading');
}

// Initialize tooltips and enhance UX
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth transitions to all interactive elements
    const interactiveElements = document.querySelectorAll('button, a, .stats-card, .activity-item');
    interactiveElements.forEach(el => {
        el.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    });
});
</script>
{% endblock %} 