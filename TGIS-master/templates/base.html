<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>GeoSurveyPro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* .fade-in { animation: fadeIn 1s ease; } */
        /* @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } */
        /* .navbar-anim:hover { transform: scale(1.05) rotate(-2deg); transition: 0.2s; } */
        /* PDF export: Animations and transitions removed for xhtml2pdf compatibility */
        #csv-map {
            height: 350px !important;
            width: 100% !important;
            position: relative !important;
            box-sizing: border-box !important;
            display: block !important;
            overflow: hidden !important;
        }
        #csv-map .leaflet-container {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            background: #e0e7ef !important;
            box-sizing: border-box !important;
            z-index: 1;
            position: static !important;
            overflow: hidden !important;
        }
        .leaflet-control.info.legend {
            z-index: 9999 !important;
            overflow: visible !important;
        }
        /* Custom animation for login/signup */
        .animate-fade-in-up {
            animation: fadeInUp 1s cubic-bezier(0.23, 1, 0.32, 1);
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(40px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-bounce-slow {
            animation: bounceSlow 2.5s infinite;
        }
        @keyframes bounceSlow {
            0%, 100% { transform: translateY(0); }
            20% { transform: translateY(-8px); }
            40% { transform: translateY(0); }
            60% { transform: translateY(-4px); }
            80% { transform: translateY(0); }
        }
    </style>
    {% block extra_css %}{% endblock %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Modern, Larger Navbar -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg shadow-2xl">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between rounded-b-2xl min-h-[84px]">
            <div class="flex items-center space-x-6">
                <a href="/" class="flex items-center gap-3 text-3xl font-extrabold text-blue-700 navbar-anim tracking-tight">
                    <img src="/static/logo.png" alt="Logo" class="w-14 h-14 rounded-full shadow-lg border-4 border-blue-200 bg-white" onerror="this.style.display='none'">
                    <span class="drop-shadow-lg">GeoSurveyPro</span>
                </a>
                <!-- Hamburger for mobile -->
                <button id="navbarToggle" class="md:hidden ml-2 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Open menu">
                    <svg class="w-7 h-7 text-blue-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
            <!-- Desktop nav links -->
            <div class="hidden md:flex items-center bg-gray-100/80 rounded-full px-4 py-2 shadow-inner space-x-2 ml-4" id="navbarLinks">
                <a href="/surveys/dashboard/" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition transform hover:scale-110">Dashboard</a>
                <a href="/upload/" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition transform hover:scale-110">Upload</a>
                <a href="/surveys/" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition transform hover:scale-110">Survey List</a>
                <a href="/surveys/map-view/" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition transform hover:scale-110">Map View</a>
                {% if user.is_authenticated and request.session.is_admin %}
                    <a href="{% url 'user_list' %}" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-green-100 hover:text-green-700 font-semibold transition transform hover:scale-110">User Management</a>
                    <a href="{% url 'admin_dashboard' %}#logs" class="px-5 py-2 rounded-full text-lg text-gray-700 hover:bg-yellow-100 hover:text-yellow-700 font-semibold transition transform hover:scale-110">Logs</a>
                {% endif %}
            </div>
            <!-- Profile/Login/Register always visible -->
            <div class="flex items-center space-x-3">
                {% if user.is_authenticated %}
                <button id="profileBtn" class="flex items-center px-5 py-2 bg-blue-100 text-blue-700 rounded-full shadow-lg navbar-anim font-semibold focus:outline-none text-lg transition transform hover:scale-110">
                    <svg class="w-7 h-7 mr-2 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span class="hidden sm:inline">Profile</span>
                </button>
                <!-- Profile Modal -->
                <div id="profileModal" class="fixed inset-0 z-50 bg-black bg-opacity-40 hidden pointer-events-none">
                    <div class="fixed top-2/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-full max-w-xs sm:max-w-md md:max-w-lg px-2 max-h-[80vh] overflow-y-auto flex flex-col items-center pointer-events-auto">
                        <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
                        <div class="flex flex-col items-center gap-2 w-full">
                            <svg class="w-16 h-16 text-blue-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            <div class="text-xl font-bold text-blue-700 mb-1 flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                {{ user.username }}
                            </div>
                            {% if user.email %}
                            <div class="text-gray-600 flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 12H8m8 0a4 4 0 11-8 0 4 4 0 018 0zm0 0v1a4 4 0 01-8 0v-1"/></svg>
                                {{ user.email }}
                            </div>
                            {% endif %}
                            {% if user.date_joined %}
                            <div class="text-gray-500 text-sm flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                Joined: {{ user.date_joined|date:"F j, Y" }}
                            </div>
                            {% endif %}
                            <hr class="my-3 w-full border-gray-200">
                            <a href="/accounts/password_change/" class="w-full py-2 px-4 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 font-semibold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-center flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c0-1.104.896-2 2-2s2 .896 2 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2c0-1.104.896-2 2-2z"/></svg>
                                Change Password
                            </a>
                            <a href="/settings/" class="w-full py-2 px-4 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center flex items-center justify-center gap-2 mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Settings
                            </a>
                            <a href="/activity/" class="w-full py-2 px-4 bg-purple-100 hover:bg-purple-200 text-purple-800 font-semibold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-400 text-center flex items-center justify-center gap-2 mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 018 0v2M9 7h.01M15 7h.01M12 7h.01M12 11v2m0 4h.01"/></svg>
                                My Activity
                            </a>
                            <a href="/help/" class="w-full py-2 px-4 bg-teal-100 hover:bg-teal-200 text-teal-800 font-semibold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-400 text-center flex items-center justify-center gap-2 mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 14h.01M16 10h.01M12 18h.01M12 6h.01"/></svg>
                                Help
                            </a>
                            {% if request.session.is_admin %}
                            <a href="{% url 'admin_dashboard' %}" class="w-full py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 text-center flex items-center justify-center gap-2 mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v4a1 1 0 001 1h3v6a1 1 0 001 1h4a1 1 0 001-1v-6h3a1 1 0 001-1V7a1 1 0 00-1-1H4a1 1 0 00-1 1z"/></svg>
                                Admin Panel
                            </a>
                            {% endif %}
                            <hr class="my-3 w-full border-gray-200">
                            <a href="/accounts/logout/" class="w-full py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 text-center flex items-center justify-center gap-2 mt-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"/></svg>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var profileBtn = document.getElementById('profileBtn');
                    var profileModal = document.getElementById('profileModal');
                    var closeProfileModal = document.getElementById('closeProfileModal');
                    if (profileBtn && profileModal && closeProfileModal) {
                        profileBtn.onclick = function() { profileModal.classList.remove('hidden'); };
                        closeProfileModal.onclick = function() { profileModal.classList.add('hidden'); };
                        profileModal.onclick = function(e) { if (e.target === profileModal) profileModal.classList.add('hidden'); };
                    }
                });
                </script>
                {% else %}
                    <a href="/accounts/login/" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg navbar-anim text-lg transition transform hover:scale-110">Login</a>
                    <a href="/accounts/register/" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full shadow-lg navbar-anim text-lg transition transform hover:scale-110">Register</a>
                {% endif %}
            </div>
        </div>
        <!-- Mobile nav links -->
        <div id="mobileNav" class="md:hidden hidden px-4 pb-4">
            <div class="flex flex-col gap-2 bg-gray-100/90 rounded-2xl shadow-lg p-4 mt-2">
                <a href="/surveys/dashboard/" class="py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition">Dashboard</a>
                <a href="/upload/" class="py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition">Upload</a>
                <a href="/surveys/" class="py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition">Survey List</a>
                <a href="/surveys/map-view/" class="py-2 rounded text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-semibold transition">Map View</a>
                {% if user.is_authenticated and request.session.is_admin %}
                    <a href="{% url 'user_list' %}" class="py-2 rounded text-gray-700 hover:bg-green-100 hover:text-green-700 font-semibold transition">User Management</a>
                    <a href="{% url 'admin_dashboard' %}#logs" class="py-2 rounded text-gray-700 hover:bg-yellow-100 hover:text-yellow-700 font-semibold transition">Logs</a>
                {% endif %}
            </div>
        </div>
        <div class="h-2 bg-gradient-to-r from-blue-500 via-green-300 to-yellow-200 w-full rounded-b-2xl shadow"></div>
    </nav>
    <script>
    // Mobile navbar toggle
    document.addEventListener('DOMContentLoaded', function() {
        var toggle = document.getElementById('navbarToggle');
        var mobileNav = document.getElementById('mobileNav');
        if (toggle && mobileNav) {
            toggle.onclick = function() {
                mobileNav.classList.toggle('hidden');
            };
        }
    });
    </script>
    <div class="max-w-7xl mx-auto px-4 py-6 fade-in">
        {% if messages %}
            <div class="space-y-2 mb-4">
                {% for message in messages %}
                    <div class="p-3 rounded shadow text-white fade-in {% if message.tags == 'error' %}bg-red-500{% elif message.tags == 'success' %}bg-green-500{% else %}bg-blue-500{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% block content %}{% endblock %}
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
if (window.location.pathname === '/surveys/upload-csv/') {
  console.log("CSV upload page script loaded");
  window.addEventListener('DOMContentLoaded', function() {
    console.log("DOMContentLoaded event fired");
    initMap();
    setupCSVPreview();
  });
  let map, markerLayer, shapeLayer, clusterLayer;
  function initMap() {
    console.log("initMap called");
    if (map) return; // Prevent multiple maps
    const mapDiv = document.getElementById('csv-map');
    console.log("Map container exists:", !!mapDiv, mapDiv);
    // Fix Leaflet's default icon paths to use CDN
    L.Icon.Default.mergeOptions({
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
    });
    map = L.map('csv-map').setView([27.7, 85.3], 8);
    console.log("Map object created:", map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    markerLayer = L.layerGroup(); // not added directly
    clusterLayer = L.markerClusterGroup();
    shapeLayer = L.layerGroup().addTo(map);
    try {
      console.log("Adding cluster layer...");
      clusterLayer.addTo(map);
      console.log("Cluster layer added.");
    } catch (e) {
      console.error("Error adding cluster layer:", e);
    }
    let defaultMarker = L.marker([27.7, 85.3]);
    defaultMarker.bindPopup('Default location: Kathmandu').openPopup();
    clusterLayer.addLayer(defaultMarker);
    var msg = document.getElementById('map-message');
    if (msg) msg.textContent = 'Select a CSV file with latitude and longitude columns to preview points or polygons on the map.';
    // Add legend
    try {
      console.log("Adding legend...");
      if (document.getElementById('csv-map')) {
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
          var div = L.DomUtil.create('div', 'info legend');
          div.style.background = 'white';
          div.style.padding = '8px 16px';
          div.style.borderRadius = '8px';
          div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
          div.innerHTML = '<b>Legend</b><br>' +
            '<i style="background:#2563eb;width:14px;height:14px;display:inline-block;border-radius:50%;margin-right:6px;"></i> Point<br>' +
            '<i style="background:#22c55e;width:14px;height:14px;display:inline-block;margin-right:6px;"></i> Polygon<br>' +
            '<i style="background:#f59e42;width:14px;height:4px;display:inline-block;margin-right:6px;vertical-align:middle;"></i> Line';
          return div;
        };
        legend.addTo(map);
        console.log("Legend added.");
      }
    } catch (e) {
      console.error("Error adding legend:", e);
    }
    setTimeout(() => { map.invalidateSize(); console.log("Map invalidated size (init)"); }, 500);
    window.addEventListener('resize', function() { map.invalidateSize(); console.log("Map invalidated size (resize)"); });
  }
  function setupCSVPreview() {
    const dropArea = document.getElementById('drop-area');
    if (!dropArea) return;
    const fileInput = dropArea.querySelector('input[type="file"]');
    dropArea.addEventListener('click', () => fileInput.click());
    dropArea.addEventListener('dragover', e => {
      e.preventDefault();
      dropArea.classList.add('bg-blue-200', 'border-blue-600');
    });
    dropArea.addEventListener('dragleave', e => {
      e.preventDefault();
      dropArea.classList.remove('bg-blue-200', 'border-blue-600');
    });
    dropArea.addEventListener('drop', e => {
      e.preventDefault();
      dropArea.classList.remove('bg-blue-200', 'border-blue-600');
      fileInput.files = e.dataTransfer.files;
      handleCSVPreview(fileInput.files[0]);
    });
    fileInput.addEventListener('change', function() {
      if (fileInput.files.length) handleCSVPreview(fileInput.files[0]);
    });
  }
  function handleCSVPreview(file) {
    if (!file || !file.name.endsWith('.csv')) return;
    if (!map) initMap();
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        if (!data.length) {
          document.getElementById('map-message').textContent = 'CSV file is empty.';
          markerLayer.clearLayers();
          clusterLayer.clearLayers();
          shapeLayer.clearLayers();
          return;
        }
        // Try to find lat/lon columns
        const columns = Object.keys(data[0]);
        let latCol = columns.find(c => c.toLowerCase().includes('lat'));
        let lonCol = columns.find(c => c.toLowerCase().includes('lon'));
        let geomCol = columns.find(c => c.toLowerCase().includes('wkt') || c.toLowerCase().includes('geometry') || c.toLowerCase().includes('geojson'));
        let bounds = [];
        markerLayer.clearLayers();
        clusterLayer.clearLayers();
        shapeLayer.clearLayers();
        let hasData = false;
        // Draw points (blue, clustered, use L.marker with custom icon)
        if (latCol && lonCol) {
          const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });
          data.forEach(row => {
            let lat = parseFloat(row[latCol]);
            let lon = parseFloat(row[lonCol]);
            if (!isNaN(lat) && !isNaN(lon)) {
              let marker = L.marker([lat, lon], { icon: blueIcon });
              marker.bindPopup('<b>Point</b><br>' + columns.map(col => `<b>${col}:</b> ${row[col]}`).join('<br>'));
              marker.on('mouseover', function(e) { marker.openPopup(); });
              marker.on('mouseout', function(e) { marker.closePopup(); });
              markerLayer.addLayer(marker);
              bounds.push([lat, lon]);
              hasData = true;
            }
          });
          clusterLayer.addLayer(markerLayer);
        }
        // Draw polygons/lines if WKT or GeoJSON present
        if (geomCol) {
          data.forEach(row => {
            let geom = row[geomCol];
            if (geom) {
              let layer = null;
              // Try GeoJSON first
              try {
                let geo = typeof geom === 'string' ? JSON.parse(geom) : geom;
                layer = L.geoJSON(geo, {
                  style: function(feature) {
                    if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                      return { color: '#22c55e', fillColor: '#bbf7d0', fillOpacity: 0.5, weight: 3 }; // green
                    } else if (feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString') {
                      return { color: '#f59e42', weight: 4 }; // orange
                    }
                  },
                  onEachFeature: function(feature, lyr) {
                    lyr.bindPopup('<b>' + feature.geometry.type + '</b><br>' + columns.map(col => `<b>${col}:</b> ${row[col]}`).join('<br>'));
                  }
                });
              } catch (e) {
                // Try WKT (simple parser for Polygon/LineString)
                if (geom.startsWith('POLYGON')) {
                  let coords = geom.match(/\(\((.*)\)\)/)[1].split(',').map(pair => pair.trim().split(' ').map(Number));
                  layer = L.polygon(coords.map(c => [c[1], c[0]]), { color: '#22c55e', fillColor: '#bbf7d0', fillOpacity: 0.5, weight: 3 });
                  layer.bindPopup('<b>Polygon</b><br>' + columns.map(col => `<b>${col}:</b> ${row[col]}`).join('<br>'));
                } else if (geom.startsWith('LINESTRING')) {
                  let coords = geom.match(/\((.*)\)/)[1].split(',').map(pair => pair.trim().split(' ').map(Number));
                  layer = L.polyline(coords.map(c => [c[1], c[0]]), { color: '#f59e42', weight: 4 });
                  layer.bindPopup('<b>LineString</b><br>' + columns.map(col => `<b>${col}:</b> ${row[col]}`).join('<br>'));
                }
              }
              if (layer) {
                layer.addTo(shapeLayer);
                if (layer.getBounds) bounds.push(...layer.getBounds().getLatLngs().flat());
                hasData = true;
              }
            }
          });
        }
        if (bounds.length) {
          map.fitBounds(bounds, {padding: [30,30]});
          document.getElementById('map-message').textContent = '';
        } else if (!hasData) {
          document.getElementById('map-message').textContent = 'No valid coordinates or shapes to display. Please check your CSV data.';
          // Show default marker again
          let defaultMarker = L.marker([27.7, 85.3]);
          defaultMarker.bindPopup('Default location: Kathmandu').openPopup();
          clusterLayer.addLayer(defaultMarker);
        }
        setTimeout(() => { map.invalidateSize(); console.log("Map invalidated size (csv preview)"); }, 500);
      },
      error: function(err) {
        document.getElementById('map-message').textContent = 'Error parsing CSV: ' + err.message;
        markerLayer.clearLayers();
        clusterLayer.clearLayers();
        shapeLayer.clearLayers();
      }
    });
  }
}
</script>
</body>
<!-- Remove debug map script -->
</html>
